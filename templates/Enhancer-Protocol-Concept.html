
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forensic Video Enhancement Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        .enhancement-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
        }
        .file-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 5px 10px;
            border-left: 3px solid #007bff;
            margin: 2px 0;
            background: #f8f9fa;
        }
        .log-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .log-success {
            border-left-color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-microscope"></i> Forensic Video ENHANCE
            </a>
            <div class="navbar-nav ms-auto" id="authSection">
                <a class="nav-link" href="#" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</a>
                <a class="nav-link" href="#" id="registerBtn"><i class="fas fa-user-plus"></i> Register</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <h2 class="card-title mb-4 text-center">
                            <i class="fas fa-wand-magic-sparkles"></i> AI Video Enhancement
                        </h2>
                        <p class="text-center text-muted mb-4">
                            Professional forensic video enhancement using advanced AI algorithms
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="enhancement-controls h-100">
                                    <h4><i class="fas fa-cogs"></i> Enhancement Controls</h4>
                                    
                                    <!-- File Selection Dropdown -->
                                    <div class="mb-3">
                                        <label class="form-label text-white"><i class="fas fa-film"></i> Select Video File:</label>
                                        <select class="form-select" id="fileSelect">
                                            <option value="" selected disabled>Choose a video file...</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Enhancement Selection Dropdown -->
                                    <div class="mb-3">
                                        <label class="form-label text-white"><i class="fas fa-magic"></i> Select Enhancement:</label>
                                        <select class="form-select" id="enhancementSelect">
                                            <option value="" selected disabled>Choose an enhancement type...</option>
                                        </select>
                                        <div id="enhancementDescription" class="form-text text-white-50 mt-2" style="display: none;">
                                            <strong>Description:</strong> <span id="descriptionText"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected File Info -->
                                    <div id="selectedFileInfo" class="file-info" style="display: none;"></div>
                                    
                                    <!-- Action Button -->
                                    <button id="enhanceBtn" class="btn btn-success w-100 mt-3" disabled>
                                        <i class="fas fa-play"></i> Start Enhancement (1 credit)
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="h-100">
                                    <h5><i class="fas fa-terminal"></i> Real-time Processing Logs</h5>
                                    <div id="processingLogs" class="mt-3" style="height: 300px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace;">
                                        <div>üîç System ready. Select a file and enhancement to begin.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-tasks"></i> Active Enhancement Jobs
                        </h5>
                        <div id="jobsList" class="mt-3">
                            <p class="text-muted">No active jobs</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-history"></i> Enhanced Videos
                        </h5>
                        <div id="enhancementsGrid" class="row mt-3">
                            <p class="text-muted">Your enhanced videos will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div class="modal fade" id="jobDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="jobDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Username or Email</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let selectedUploadId = null;
        let selectedEnhancement = null;
        let uploadedFiles = [];

        // Check authentication on load
        checkAuth();
        loadUploadedFiles();
        loadEnhancementTypes();

        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/auth/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const result = await response.json();
                        currentUser = result.user;
                        updateAuthUI();
                        loadJobs();
                        loadEnhancements();
                    }
                } catch (error) {
                    localStorage.removeItem('authToken');
                }
            }
        }

        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('authSection').innerHTML = `
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> ${currentUser.username} (${currentUser.credits} credits)
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </li>
                `;
            }
        }

        async function loadUploadedFiles() {
            try {
                const response = await fetch('/files/uploaded', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    uploadedFiles = result.files;
                    updateFileDropdown();
                }
            } catch (error) {
                console.error('Error loading uploaded files:', error);
            }
        }

        function updateFileDropdown() {
            const select = document.getElementById('fileSelect');
            let html = '<option value="" selected disabled>Choose a video file...</option>';
            
            if (uploadedFiles.length === 0) {
                html += '<option value="" disabled>No uploaded files found</option>';
            } else {
                uploadedFiles.forEach(file => {
                    const sizeMB = (file.size_bytes / 1024 / 1024).toFixed(2);
                    html += `<option value="${file.id}">
                        ${file.filename} (${sizeMB}MB)
                    </option>`;
                });
            }
            
            select.innerHTML = html;
            
            // Add event listener for file selection
            select.addEventListener('change', function() {
                selectedUploadId = this.value;
                const fileInfo = uploadedFiles.find(f => f.id == selectedUploadId);
                
                if (fileInfo) {
                    document.getElementById('selectedFileInfo').style.display = 'block';
                    document.getElementById('selectedFileInfo').innerHTML = `
                        <strong>Selected File:</strong> ${fileInfo.filename}<br>
                        <strong>Size:</strong> ${(fileInfo.size_bytes / 1024 / 1024).toFixed(2)}MB<br>
                        <strong>Uploaded:</strong> ${new Date(fileInfo.created_at).toLocaleString()}
                    `;
                }
                
                updateEnhanceButton();
            });
        }

        async function loadEnhancementTypes() {
            try {
                const response = await fetch('/enhancement/types');
                const result = await response.json();
                
                const select = document.getElementById('enhancementSelect');
                let html = '<option value="" selected disabled>Choose an enhancement type...</option>';
                
                // Group enhancements by category
                const categories = {
                    "Resolution & Quality": {},
                    "Noise & Artifact Removal": {},
                    "Motion & Stabilization": {},
                    "Color & Grayscale": {},
                    "Specialized Forensic": {}
                };
                
                // Categorize enhancements
                for (const [key, description] of Object.entries(result.enhancement_types)) {
                    if (key.includes('resolution') || key.includes('super_res') || key.includes('interpolation') || key.includes('slow_motion')) {
                        categories["Resolution & Quality"][key] = description;
                    } else if (key.includes('denoising') || key.includes('artifact') || key.includes('dehazing')) {
                        categories["Noise & Artifact Removal"][key] = description;
                    } else if (key.includes('stabilization') || key.includes('deblur') || key.includes('motion')) {
                        categories["Motion & Stabilization"][key] = description;
                    } else if (key.includes('color') || key.includes('grayscale') || key.includes('hsv') || 
                               key.includes('histogram') || key.includes('threshold') || key.includes('skin') ||
                               key.includes('license') || key.includes('infrared')) {
                        categories["Color & Grayscale"][key] = description;
                    } else {
                        categories["Specialized Forensic"][key] = description;
                    }
                }
                
                // Build dropdown with optgroups
                for (const [category, enhancements] of Object.entries(categories)) {
                    if (Object.keys(enhancements).length > 0) {
                        html += `<optgroup label="${category}">`;
                        for (const [key, description] of Object.entries(enhancements)) {
                            html += `<option value="${key}">${description}</option>`;
                        }
                        html += `</optgroup>`;
                    }
                }
                
                select.innerHTML = html;
                
                // Add event listener for enhancement selection
                select.addEventListener('change', function() {
                    selectedEnhancement = this.value;
                    const description = result.enhancement_types[selectedEnhancement];
                    
                    // Show description
                    document.getElementById('enhancementDescription').style.display = 'block';
                    document.getElementById('descriptionText').textContent = description;
                    
                    updateEnhanceButton();
                });
                
            } catch (error) {
                console.error('Error loading enhancement types:', error);
            }
        }

        function updateEnhanceButton() {
            const enhanceBtn = document.getElementById('enhanceBtn');
            if (selectedUploadId && selectedEnhancement && currentUser) {
                enhanceBtn.disabled = false;
            } else {
                enhanceBtn.disabled = true;
            }
        }

        async function startEnhancement() {
            if (!currentUser) {
                alert('Please login first');
                return;
            }

            if (!selectedUploadId) {
                alert('Please select a video file first');
                return;
            }

            if (!selectedEnhancement) {
                alert('Please select an enhancement type');
                return;
            }

            try {
                addLog('üöÄ Starting enhancement process...', 'info');
                
                const response = await fetch('/enhance/video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        upload_id: selectedUploadId,
                        enhancement_type: selectedEnhancement
                    })
                });

                const result = await response.json();
                if (result.success) {
                    addLog(`‚úÖ Enhancement started! Job ID: ${result.job_id}`, 'success');
                    connectToJobWebSocket(result.job_id);
                    loadJobs();
                    
                    // Reset selections
                    document.getElementById('fileSelect').value = '';
                    document.getElementById('enhancementSelect').value = '';
                    document.getElementById('selectedFileInfo').style.display = 'none';
                    document.getElementById('enhancementDescription').style.display = 'none';
                    document.getElementById('enhanceBtn').disabled = true;
                    selectedUploadId = null;
                    selectedEnhancement = null;
                    
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                alert('Error: ' + error.message);
            }
        }

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('processingLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Attach enhance button event
        document.getElementById('enhanceBtn').addEventListener('click', startEnhancement);

        async function loadJobs() {
            if (!currentUser) return;

            try {
                const response = await fetch('/jobs', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const result = await response.json();
                
                const jobsList = document.getElementById('jobsList');
                if (result.jobs && result.jobs.length > 0) {
                    jobsList.innerHTML = result.jobs.map(job => `
                        <div class="card mb-2">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${job.enhancement_type}</strong>
                                        <br>
                                        <small class="text-muted">${job.upload_filename || 'Unknown file'}</small>
                                        <br>
                                        <small class="text-muted">${new Date(job.created_at).toLocaleString()}</small>
                                        <br>
                                        <span class="badge bg-${getStatusColor(job.status)}">${job.status} (${job.progress}%)</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewJobDetails(${job.id})">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                        ${job.status === 'completed' ? `
                                            <a href="/download/${job.id}" class="btn btn-sm btn-success">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                                ${job.status === 'running' ? `
                                    <div class="progress mt-2" style="height: 5px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${job.progress}%"></div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    jobsList.innerHTML = '<p class="text-muted">No active enhancement jobs</p>';
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function viewJobDetails(jobId) {
            try {
                const response = await fetch(`/jobs/${jobId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const result = await response.json();
                
                const content = document.getElementById('jobDetailsContent');
                content.innerHTML = `
                    <h6>Job Information</h6>
                    <table class="table table-sm">
                        <tr><th>ID:</th><td>${result.job.id}</td></tr>
                        <tr><th>Type:</th><td>${result.job.enhancement_type}</td></tr>
                        <tr><th>Status:</th><td><span class="badge bg-${getStatusColor(result.job.status)}">${result.job.status}</span></td></tr>
                        <tr><th>Progress:</th><td>${result.job.progress}%</td></tr>
                        <tr><th>Created:</th><td>${new Date(result.job.created_at).toLocaleString()}</td></tr>
                        ${result.job.started_at ? `<tr><th>Started:</th><td>${new Date(result.job.started_at).toLocaleString()}</td></tr>` : ''}
                        ${result.job.completed_at ? `<tr><th>Completed:</th><td>${new Date(result.job.completed_at).toLocaleString()}</td></tr>` : ''}
                        ${result.job.time_taken ? `<tr><th>Time Taken:</th><td>${result.job.time_taken.toFixed(2)} seconds</td></tr>` : ''}
                    </table>
                    
                    <h6 class="mt-3">Processing Logs</h6>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${result.logs.map(log => `
                            <div class="log-entry ${log.level === 'error' ? 'log-error' : log.level === 'info' ? '' : 'log-success'}">
                                [${new Date(log.created_at).toLocaleTimeString()}] ${log.message}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
            } catch (error) {
                console.error('Error loading job details:', error);
            }
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'running': 'primary',
                'completed': 'success',
                'failed': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function connectToJobWebSocket(jobId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${jobId}`;
            const ws = new WebSocket(wsUrl);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'progress') {
                    addLog(`üìà ${data.message}`, 'info');
                    loadJobs(); // Refresh jobs list
                }
            };
            
            ws.onclose = function() {
                addLog('üîå WebSocket connection closed', 'info');
            };
        }

        async function loadEnhancements() {
            if (!currentUser) return;

            try {
                const response = await fetch('/enhancements', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const result = await response.json();
                
                const grid = document.getElementById('enhancementsGrid');
                if (result.enhancements && result.enhancements.length > 0) {
                    grid.innerHTML = result.enhancements.map(enh => `
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6>${enh.enhancement_type}</h6>
                                    <p class="small text-muted">${enh.original_filename || 'Unknown file'}</p>
                                    <p class="small text-muted">Enhanced on ${new Date(enh.created_at).toLocaleString()}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-light text-dark">${enh.time_taken ? enh.time_taken.toFixed(2) + 's' : 'N/A'}</span>
                                        <a href="/download/${enh.id}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p class="text-muted">No enhanced videos yet</p>';
                }
            } catch (error) {
                console.error('Error loading enhancements:', error);
            }
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const payload = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.success) {
                    localStorage.setItem('authToken', result.token);
                    currentUser = result.user;
                    updateAuthUI();
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    loadJobs();
                    loadEnhancements();
                    loadUploadedFiles();
                    addLog('‚úÖ Login successful!', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addLog(`‚ùå Login failed: ${error.message}`, 'error');
            }
        });

        function logout() {
            localStorage.removeItem('authToken');
            currentUser = null;
            updateAuthUI();
            document.getElementById('jobsList').innerHTML = '<p class="text-muted">Please login to view jobs</p>';
            document.getElementById('enhancementsGrid').innerHTML = '<p class="text-muted">Please login to view enhancements</p>';
            document.getElementById('fileSelect').innerHTML = '<option value="" selected disabled>Please login to view files</option>';
            addLog('üîí Logged out successfully', 'info');
        }

        // Modal triggers
        document.getElementById('loginBtn')?.addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        });

        // Auto-refresh
        setInterval(() => {
            if (currentUser) {
                loadJobs();
                loadEnhancements();
            }
        }, 5000);
    </script>
</body>
</html>